import uncertainpy as un
import chaospy as cp
import numpy as np
import time
import os
import matplotlib.pyplot as plt
####SELECIONE AQUI O PACIENTE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
pat_select = 3#1#2#...at√© 17
#pegar pontos experimentais
t_exp = [np.array([0.0, 0.04, 0.09, 0.17, 0.34, 0.50, 1.00, 1.50, 2.98, 4.91, 6.92, 10.94, 13.96, 20.91, 27.98, 41.85, 56.00, 66.88]) #PATB07
        ,np.array([0.0, 0.04, 0.09, 0.17, 0.34, 0.50, 1.00, 1.50, 2.98, 4.90, 6.94, 10.96, 14.95, 20.96, 28.03, 42.00, 55.97, 66.92]) #PATB09
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.34, 0.51, 1.00, 1.50, 2.91, 4.92, 6.91, 10.87, 13.86, 20.87, 25.92, 39.96, 53.93, 67.93]) #PATB08
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.34, 0.50, 1.00, 1.50, 3.01, 6.01, 7.00, 9.99, 14.00, 20.98, 30.01, 44.01, 55.01, 72.02]) #PATB16
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.01, 1.50, 2.99, 6.03, 7.02, 9.98, 14.04, 21.03, 30.03, 44.03, 55.00, 72.03]) #PATB17
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 0.92, 1.50, 2.95, 4.89, 6.88, 8.85, 13.85, 20.86, 27.96, 41.97, 53.92, 67.89]) #PATB06
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.00, 1.50, 2.86, 6.91, 8.86, 9.88, 13.90, 21.87, 30.87, 41.93, 55.88]) #PATC05
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.48, 1.00, 1.50, 2.94, 5.99, 7.01, 9.91, 15.00, 22.00, 28.02, 44.01, 57.01, 70.00]) #PATC06
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.34, 0.50, 1.00, 1.50, 2.96, 3.94, 7.94, 9.95, 14.94, 24.03, 30.94, 44.91, 58.92, 72.11]) #PATC09
        ,np.array([0.0, 0.04, 0.09, 0.18, 0.33, 0.50, 1.00, 1.50, 2.96, 3.98, 7.00, 9.98, 13.97, 21.96, 30.02, 41.89, 55.97, 70.01]) #PATC10
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.00, 1.50, 3.00, 6.01, 7.01, 10.02,14.01, 20.97, 28.01, 42.02, 56.02, 70.02]) #PATB15
        ,np.array([0.0, 0.04, 0.09, 0.17, 0.33, 0.50, 1.00, 1.50, 3.00, 4.03, 6.99, 9.99, 16.07, 21.01, 28.02, 42.95, 56.05, 70.02]) #PATB11
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.00, 1.50, 3.00, 3.95, 6.98, 9.98, 15.97, 20.99, 28.02, 42.99, 55.97, 70.01]) #PATB10
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.51, 1.00, 1.50, 2.87, 3.83, 8.84, 15.87,22.85, 29.83, 44.90, 58.84, 72.85]) #PATC04
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.00, 1.50, 2.94, 5.93, 7.93, 9.94, 13.97, 20.96, 28.05, 42.06, 55.92, 71.08]) #PATC16
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.00, 1.50, 2.92, 7.07, 8.04, 9.07, 13.06, 23.08, 26.92, 42.00, 57.01, 69.93]) #PATC15
        ,np.array([0.0, 0.04, 0.09, 0.17, 0.34, 0.50, 1.00, 1.50, 2.91, 5.96, 8.96, 12.96,14.93, 20.96, 28.94, 43.94, 55.90, 70.92]) #PATC17
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.34, 0.50, 1.00, 1.50, 2.97, 5.99, 7.97, 10.06,14.06, 21.02, 28.04, 44.07, 56.03, 70.01]) #PATC14
        ]
patients = []
PATB07 = [4.1510, 4.2227, 4.0733, 3.0599, 2.2122, 1.7924, 1.6435, 1.7160, 1.6435, 1.2304, 1.0792, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000]
PATB09 = [6.3541, 6.2734, 6.0103, 5.9685, 5.6755, 5.5739, 5.4454, 4.9222, 5.1703, 4.8385, 4.1949, 3.0931, 2.1790, 1.5682, 1.5051, 1.0000, 1.0000, 1.0000]
PATB08 = [5.7831, 5.6546, 5.6486, 4.6203, 3.6876, 3.1526, 2.6355, 2.5302, 2.6294, 2.2788, 2.0719, 1.9031, 1.7924, 1.6335, 1.5682, 1, 1, 1]
PATB16 = [6.2943, 6.3541, 6.3212, 5.5915, 4.1949, 3.8517, 3.6651, 3.4814, 3.2529, 3.0120, 3.0302, 2.7528, 2.3838, 2.1818, 1.9243, 1.7160, 1, 1]
PATB17 = [6.1927, 6.4885, 6.5486, 5.6096, 4.4266, 3.8878, 3.2076, 3.1626, 2.9128, 2.8432, 2.7474, 2.7016, 2.3541, 2.0453, 1.4914, 1, 1, 1]
PATB06 = [6.2584, 6.3780, 6.4109, 5.6277, 4.4948, 3.9268, 3.1973, 2.8537, 2.5340, 2.4378, 2.3404, 2.3345, 2.2355, 2.0492, 2.1173, 1.3424, 1.7559, 1.1461]
PATC05 = [6.208568, 6.394490, 6.254302, 5.833741, 4.727484, 3.889414, 3.261501, 3.182415, 2.990339, 2.609594, 2.527630, 2.743510, 2.694605, 2.227887, 1.863323, 1.785330, 1.431364]
PATC06 = [6.808956, 6.839431, 6.735814, 6.452393, 5.340039, 4.581198, 3.481012, 3.164055, 2.780317, 2.484300, 2.509203, 2.369216, 1.949390, 1.623249, 1.556303, 1.000000, 1.000000, 1.000000]
PATC09 = [6.296968, 6.424965, 6.303063, 6.028728, 4.642148, 4.349588, 3.484015, 3.243286, 2.816904, 2.576341, 2.089905, 2.025306, 1.698970, 1.278754, 1.342423, 1.000000, 1.000000, 1.000000]
PATC10 = [5.547272, 5.583842, 5.455846, 4.754914, 3.447468, 2.749736, 2.311754, 2.158362, 1.944483, 1.707570, 1.322219, 1.322219, 1.000000, 1.000000, 1.000000, 1.000000, 1.000000, 1.000000]
PATB15 = [5.3108, 5.2514, 5.2002, 4.0835, 3.2017, 2.9759, 2.1038, 2.1959, 1.3222, 1.0000, 1.1139, 1, 1, 1, 1, 1, 1, 1]
PATB11 = [6.0881,6.1478,6.0223,5.2421,3.8581,3.4216,2.8808,2.7168,2.2718,2.0170,1.6721,1.3222,1,1,1,1,1,1]
PATB10 = [6.3840,6.4587,6.4587,6.1718,5.4932,4.9461,3.5412,3.1535,2.4669,2.3945,1.9294,1.6990,1,1,1,1,1,1]
PATC04 = [6.7323,6.4158,6.5225,5.6844,4.4105,3.8132,3.1732,2.7987,2.5611,2.3962,1.9031, 1, 1, 1, 1, 1, 1]
PATC16 = [6.1903,6.0958,6.0654,5.4680,4.5812,4.2582,3.7706,3.5206,3.0637,2.6212,2.4728,2.1790,1.7782,1.1461, 1, 1, 1, 1]
PATC15 = [3.2524, 2.5145, 2.4116, 2.4014, 1.9243, 1.8633, 1.5052, 1.5441, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
PATC17 = [6.0135,5.9922,5.9374,5.3949,3.7766,3.1000,2.6335,2.6304,2.0934,1.4771,1.1761, 1, 1, 1, 1, 1, 1, 1]
PATC14 = [5.9922,5.8673,5.8764,5.6997,5.0688,4.5903,4.0052,3.3286,2.6702,1.8865,1.5185, 1, 1, 1, 1, 1, 1, 1]

patients.append(PATB07)
patients.append(PATB09)
patients.append(PATB08)
patients.append(PATB16)
patients.append(PATB17)
patients.append(PATB06)
patients.append(PATC05)
patients.append(PATC06)
patients.append(PATC09)
patients.append(PATC10) #Este ao lado eh o 10. (pat_select =9)
patients.append(PATB15)
patients.append(PATB11)
patients.append(PATB10)
patients.append(PATC04)
patients.append(PATC16)
patients.append(PATC15)
patients.append(PATC17)
patients.append(PATC14)

param = [ 
        [10**4.1510, 0.21928534 , 0.21638928 , 0.12977138 ,25.92098335,  2.23911287 , 0.11649617,
  1.89169374 ,13.8363859 ,  1.26010217  ,1.87679483, 11.88302454], #PATB07
        [10**6.3541, 0.28222842,  0.66834736 , 0.6486013 , 34.85189093  ,0.28758789  ,0.50692094,
  0.24116829, 11.97826871 , 1.96749891 , 1.5104306,  16.14767842], #PATB09
        [10**5.7831, 0.75872635 , 0.70061898 , 0.54744178 ,30.82210068 , 7.70604301,  0.07392793,
  1.4049505 , 13.48064292 , 1.18071849 , 1.0885278 , 13.28720728],#PATB08
        [10**6.2943, 0.74571259 , 0.60914091 , 0.37809828, 24.17278776  ,3.89468801 , 0.09233662,
  1.32063672 , 4.31529123,  1.37549584 , 1.25138428 ,11.99931134],#PATB16
        [10**6.1927,0.60760242 , 0.85226575 , 0.72787022 ,20.55536823 , 8.15574497  ,0.07900266,
  0.8179568  ,11.59115302,  1.87962935,  1.56322571, 10.05117602],#PATB17
        [10**6.2584, 0.19615326 , 0.91975414 , 0.76369041, 57.71312021 , 2.33937683 , 0.0671441,
  0.68692254 ,11.96811295 , 1.21253232 , 1.25191448 ,11.14210376], #PATB06
        [10**6.208568, 0.43565363  ,0.77492479  ,0.74091286 ,39.89775208 , 2.7296242 ,  0.07854154,
  1.60237045 , 7.67616213,  1.01595055,  1.78423736, 10.03883896], #PATC05
        [10**6.808956, 0.56266401 , 0.87278125 , 0.30980379, 52.06935055 , 3.61211165 , 0.1890996,
  0.54561971 ,11.32363001 , 1.27738544 , 1.92670597, 10.31109402], #PATC06
        [10**6.296968, 0.74417498  ,0.70831777 , 0.550319  , 36.57643106 , 4.08837567,  0.30047775,
  1.3087064 ,  8.58586111,  1.37007074  ,1.77641298 ,10.0037719], #PATC09
        [10**5.547272, 0.27157028,  0.86420408 , 0.96894352 ,20.89637426 , 7.08392837  ,0.34129581,
  1.62196995, 13.72691531  ,1.69627088  ,1.85262967 ,12.12470588], #PATC10
      [10**5.3108, 0.18, 0.899, 0.64, 27.27, 4.2,
  1.25, 0.27, 12.4, 1.22, 1.61, 13.77], #PATB15 (pat_select =10)
      [10**6.0881,0.40795188,  0.85662938  ,0.38576463, 31.08294829  ,4.83680354  ,0.38578465,
  0.55534497 ,11.04482823 , 1.19384239,  1.57343438 ,12.30202224], #PATB11
      [10**6.3840, 0.7116671 ,  0.83490328  ,0.21387254, 48.76564459,  1.45182806 , 1.62133066,
  0.51986784,  4.11277247 , 1.52380935,  1.49601569, 10.50378004], #PATB10
      [10**6.7323, 0.36582068 , 0.85316093 , 0.10206855, 55.46745303 , 3.64235218  ,0.29775813,
  0.8877812,  10.58732368 , 1.09180619 , 1.00353855, 12.81901701], #PATC04
      [10**6.1903,0.11302258  ,0.80547486,  0.76123935, 27.43601407 , 1.90747224,  0.2174586,
  1.91952466 , 1.46745255 , 1.87224463  ,1.28659025 ,10.57526391], #PATC16
      [10**3.2524, 0.72292993 , 0.45173485 , 0.31185431 ,31.17047608 , 5.0364919  , 0.75339968,
  1.71122079 ,10.95415303,  1.57627694,  1.27557748 ,24.04445168], #PATC15
      [10**6.0135, 0.36421593,  0.84164179  ,0.9637999 , 24.53496941  ,4.34950112 , 0.61744015,
  1.70842924, 12.78115539  ,1.35878267 , 1.55056751 ,11.84234343], #PATC17
      [10**5.9922, 0.28421834 , 0.71237902 , 0.13467246, 41.58497553  ,0.74577491 , 1.56264662,
  0.83885209 , 4.70517267  ,1.20440994  ,1.43949327 ,12.08051635] #PATC14 #(pat_select =17)
]

V0, epsilon_r, epsilon_alpha, epsilon_s, alpha, r, delta, mu_c, rho, theta, sigma, c = param[pat_select]

with open('parametros_DE.txt', 'w') as filep:
        filep.write(str(V0)+","+str(epsilon_r)+","+str(epsilon_alpha)+","+str(epsilon_s)+
        ","+str(alpha)+","+str(r)+","+str(delta)+
        ","+str(mu_c)+","+str(rho)+","+str(theta)+
        ","+str(sigma)+","+str(c))
cwd = os.getcwd()
os.system("make clean")
os.system("make")
os.system("make run")
tempo = np.empty(0)
viral_load = np.empty(0)
with open(str(cwd)+"/saida.txt", 'r') as f:
    lista = [line.split(',')  for line in f]
    for linha in lista:
        tempo = np.append(tempo, float(linha[0]))
        viral_load = np.append(viral_load, float(linha[1]))

viral_load = np.log10(viral_load)

pat_name = []
pat_name.append("PATB07")
pat_name.append("PATB09")
pat_name.append("PATB08")
pat_name.append("PATB16")
pat_name.append("PATB17")
pat_name.append("PATB06")
pat_name.append("PATC05")
pat_name.append("PATC06")
pat_name.append("PATC09")
pat_name.append("PATC10")
pat_name.append("PATB15")
pat_name.append("PATB11")
pat_name.append("PATB10")
pat_name.append("PATC04")
pat_name.append("PATC16")
pat_name.append("PATC15")
pat_name.append("PATC17")
pat_name.append("PATC14")
plt.plot(t_exp[pat_select], patients[pat_select], 'or', label="experimental data")
plt.plot(tempo, viral_load, '-b', label="results model C++")
plt.title(pat_name[pat_select])
plt.ylabel("Viral load $log_{10}$")
plt.xlabel("Days")
plt.legend()
plt.savefig(str(cwd)+"/figuras_teste_dos_parametros/"+"patient"+str(pat_name[pat_select])+".png", dpi=300)
plt.show()