import uncertainpy as un
import chaospy as cp
import numpy as np
import time
import os
import matplotlib.pyplot as plt
####SELECIONE AQUI O PACIENTE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
pat_select = 9#1#2#...at√© 9
#pegar pontos experimentais
t_exp = [np.array([0.0, 0.04, 0.09, 0.17, 0.34, 0.50, 1.00, 1.50, 2.98, 4.91, 6.92, 10.94, 13.96, 20.91, 27.98, 41.85, 56.00, 66.88]) #PATB07
        ,np.array([0.0, 0.04, 0.09, 0.17, 0.34, 0.50, 1.00, 1.50, 2.98, 4.90, 6.94, 10.96, 14.95, 20.96, 28.03, 42.00, 55.97, 66.92]) #PATB09
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.34, 0.51, 1.00, 1.50, 2.91, 4.92, 6.91, 10.87, 13.86, 20.87, 25.92, 39.96, 53.93, 67.93]) #PATB08
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.34, 0.50, 1.00, 1.50, 3.01, 6.01, 7.00, 9.99, 14.00, 20.98, 30.01, 44.01, 55.01, 72.02]) #PATB16
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.01, 1.50, 2.99, 6.03, 7.02, 9.98, 14.04, 21.03, 30.03, 44.03, 55.00, 72.03]) #PATB17
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 0.92, 1.50, 2.95, 4.89, 6.88, 8.85, 13.85, 20.86, 27.96, 41.97, 53.92, 67.89]) #PATB06
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.50, 1.00, 1.50, 2.86, 6.91, 8.86, 9.88, 13.90, 21.87, 30.87, 41.93, 55.88]) #PATC05
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.33, 0.48, 1.00, 1.50, 2.94, 5.99, 7.01, 9.91, 15.00, 22.00, 28.02, 44.01, 57.01, 70.00]) #PATC06
        ,np.array([0.0, 0.04, 0.08, 0.17, 0.34, 0.50, 1.00, 1.50, 2.96, 3.94, 7.94, 9.95, 14.94, 24.03, 30.94, 44.91, 58.92, 72.11]) #PATC09
        ,np.array([0.0, 0.04, 0.09, 0.18, 0.33, 0.50, 1.00, 1.50, 2.96, 3.98, 7.00, 9.98, 13.97, 21.96, 30.02, 41.89, 55.97, 70.01]) #PATC10
        ]
patients = []
PATB07 = [4.1510, 4.2227, 4.0733, 3.0599, 2.2122, 1.7924, 1.6435, 1.7160, 1.6435, 1.2304, 1.0792, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000]
PATB09 = [6.3541, 6.2734, 6.0103, 5.9685, 5.6755, 5.5739, 5.4454, 4.9222, 5.1703, 4.8385, 4.1949, 3.0931, 2.1790, 1.5682, 1.5051, 1.0000, 1.0000, 1.0000]
PATB08 = [5.7831, 5.6546, 5.6486, 4.6203, 3.6876, 3.1526, 2.6355, 2.5302, 2.6294, 2.2788, 2.0719, 1.9031, 1.7924, 1.6335, 1.5682, 1, 1, 1]
PATB16 = [6.2943, 6.3541, 6.3212, 5.5915, 4.1949, 3.8517, 3.6651, 3.4814, 3.2529, 3.0120, 3.0302, 2.7528, 2.3838, 2.1818, 1.9243, 1.7160, 1, 1]
PATB17 = [6.1927, 6.4885, 6.5486, 5.6096, 4.4266, 3.8878, 3.2076, 3.1626, 2.9128, 2.8432, 2.7474, 2.7016, 2.3541, 2.0453, 1.4914, 1, 1, 1]
PATB06 = [6.2584, 6.3780, 6.4109, 5.6277, 4.4948, 3.9268, 3.1973, 2.8537, 2.5340, 2.4378, 2.3404, 2.3345, 2.2355, 2.0492, 2.1173, 1.3424, 1.7559, 1.1461]
PATC05 = [6.208568, 6.394490, 6.254302, 5.833741, 4.727484, 3.889414, 3.261501, 3.182415, 2.990339, 2.609594, 2.527630, 2.743510, 2.694605, 2.227887, 1.863323, 1.785330, 1.431364]
PATC06 = [6.808956, 6.839431, 6.735814, 6.452393, 5.340039, 4.581198, 3.481012, 3.164055, 2.780317, 2.484300, 2.509203, 2.369216, 1.949390, 1.623249, 1.556303, 1.000000, 1.000000, 1.000000]
PATC09 = [6.296968, 6.424965, 6.303063, 6.028728, 4.642148, 4.349588, 3.484015, 3.243286, 2.816904, 2.576341, 2.089905, 2.025306, 1.698970, 1.278754, 1.342423, 1.000000, 1.000000, 1.000000]
PATC10 = [5.547272, 5.583842, 5.455846, 4.754914, 3.447468, 2.749736, 2.311754, 2.158362, 1.944483, 1.707570, 1.322219, 1.322219, 1.000000, 1.000000, 1.000000, 1.000000, 1.000000, 1.000000]

patients.append(PATB07)
patients.append(PATB09)
patients.append(PATB08)
patients.append(PATB16)
patients.append(PATB17)
patients.append(PATB06)
patients.append(PATC05)
patients.append(PATC06)
patients.append(PATC09)
patients.append(PATC10)

param = [ 
        [10**4.1510, 0.21928534 , 0.21638928 , 0.12977138 ,25.92098335,  2.23911287 , 0.11649617,
  1.89169374 ,13.8363859 ,  1.26010217  ,1.87679483, 11.88302454],
        [10**6.3541, 0.46371661 , 0.36439784,  0.17204857, 35.09204152,  0.30620933,  0.49450961,
  0.19102386, 12.38871205 , 1.76602833  ,1.3258528 , 12.2144599],
        [10**5.7831, 0.44337649 , 0.82917142 , 0.74418407, 37.32531965,  4.26579463 , 0.21891538,
  0.91316669 ,12.29027152,  1.00669803 , 1.81444659 ,12.77811701],
        [10**6.2943, 0.43637562,  0.55206143 , 0.60416104, 22.83267121  ,2.83100979,  0.17308118,
  1.14085529,  9.21858818 , 1.07474572  ,1.77270468, 10.89909026],
        [10**6.1927,0.60760242 , 0.85226575 , 0.72787022 ,20.55536823 , 8.15574497  ,0.07900266,
  0.8179568  ,11.59115302,  1.87962935,  1.56322571, 10.05117602],
        [10**6.2584, 0.21439888 , 0.83440633,  0.33718629, 56.79639892 , 2.96958636 , 0.5656756,
  0.16154895 , 9.32667565,  1.40237818 , 1.68339019 ,10.68983485],
        [10**6.208568, 0.43565363  ,0.77492479  ,0.74091286 ,39.89775208 , 2.7296242 ,  0.07854154,
  1.60237045 , 7.67616213,  1.01595055,  1.78423736, 10.03883896], 
        [10**6.808956,0.52071308 , 0.93804557 , 0.669037  , 55.07498776,  1.81757963 , 0.07506626,
  0.38710693, 13.86806639  ,1.77618399,  1.74138429, 10.05974658],
        [10**6.296968, 0.74417498  ,0.70831777 , 0.550319  , 36.57643106 , 4.08837567,  0.30047775,
  1.3087064 ,  8.58586111,  1.37007074  ,1.77641298 ,10.0037719],
        [10**5.547272, 0.27157028,  0.86420408 , 0.96894352 ,20.89637426 , 7.08392837  ,0.34129581,
  1.62196995, 13.72691531  ,1.69627088  ,1.85262967 ,12.12470588]
]

V0, epsilon_r, epsilon_alpha, epsilon_s, alpha, r, delta, mu_c, rho, theta, sigma, c = param[pat_select]

with open('parametros_DE.txt', 'w') as filep:
        filep.write(str(V0)+","+str(epsilon_r)+","+str(epsilon_alpha)+","+str(epsilon_s)+
        ","+str(alpha)+","+str(r)+","+str(delta)+
        ","+str(mu_c)+","+str(rho)+","+str(theta)+
        ","+str(sigma)+","+str(c))
cwd = os.getcwd()
os.system("make clean")
os.system("make")
os.system("make run")
tempo = np.empty(0)
viral_load = np.empty(0)
with open(str(cwd)+"/saida.txt", 'r') as f:
    lista = [line.split(',')  for line in f]
    for linha in lista:
        tempo = np.append(tempo, float(linha[0]))
        viral_load = np.append(viral_load, float(linha[1]))

viral_load = np.log10(viral_load)

pat_name = []
pat_name.append("PATB07")
pat_name.append("PATB09")
pat_name.append("PATB08")
pat_name.append("PATB16")
pat_name.append("PATB17")
pat_name.append("PATB06")
pat_name.append("PATC05")
pat_name.append("PATC06")
pat_name.append("PATC09")
pat_name.append("PATC10")
plt.plot(t_exp[pat_select], patients[pat_select], 'or', label="experimental data")
plt.plot(tempo, viral_load, '-b', label="results model C++")
plt.title(pat_name[pat_select])
plt.ylabel("Viral load $log_{10}$")
plt.xlabel("Days")
plt.legend()
plt.savefig(str(cwd)+"/figuras_teste_dos_parametros/"+"patient"+str(pat_select)+".png", dpi=300)
plt.show()